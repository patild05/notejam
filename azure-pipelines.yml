name: $(TeamProject)_$(BuildDefinitionName)_$(SourceBranchName)_$(Date:yyyyMMdd)$(Rev:.r)

trigger:
- main

variables:
  agent_vmimage: "windows-latest"
  agent_pool: "CCC-Hosted"
  azure_subscription_connection: "ARM - TSE AZ Eng01"
  artifact_path: "Infrastructure"
  artifact_name: "Infrastructure"

pool:
  vmImage: $(agent_vmimage)

# Jobs
jobs:
  # Publish Artifacts
  - job: artifacts
    pool: $(agent_pool)
    #pool:
    #  vmImage: $(agent_vmimage)
    continueOnError: false
    workspace:
      clean: outputs

    steps:     
      - task: PublishPipelineArtifact@1
        displayName: 'Publish Pipeline Artifact'
        inputs:
          targetPath: $(artifact_path)
          artifact: $(artifact_name)
      

  # Deploy
  - job: deploy
    dependsOn: artifacts
    pool: $(agent_pool)
    #pool:
    #  vmImage: $(agent_vmimage)
    continueOnError: false
    workspace:
      clean: outputs

    steps:
    - checkout: none

    - task: DownloadPipelineArtifact@2
      displayName: 'Download Pipeline Artifact'
      inputs:
        artifactName: $(artifact_name)

    - task: AzurePowerShell@5
      displayName: 'Azure PowerShell script: FilePath'
      enabled: true
      inputs:
        azureSubscription: $(azure_subscription_connection)
        ScriptPath: '$(Pipeline.Workspace)/$(artifact_name)/main.ps1'
        ScriptArguments: '-ApplicationName note09 -Environment d -Location northeurope'
        azurePowerShellVersion: LatestVersion
